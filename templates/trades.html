{% extends "base.html" %}
{% block title %}Trades - Trading Journal{% endblock %}
{% block content %}
<h2>Trades pour {{ journal.nom }}</h2>
<form method="POST" enctype="multipart/form-data">
  <h4>Ajouter un Trade</h4>
  <div class="form-row">
    <div class="form-group col-md-4">
      <label for="date_debut">Date de début</label>
      <input type="date" class="form-control" name="date_debut" required>
    </div>
    <div class="form-group col-md-4">
      <label for="heure_debut">Heure de début</label>
      <input type="time" class="form-control" name="heure_debut" required>
    </div>
    <div class="form-group col-md-4">
      <label for="session">Session</label>
      <select class="form-control" name="session" required>
        <option value="Londres">Londres</option>
        <option value="New York">New York</option>
        <option value="Tokyo">Tokyo</option>
        <option value="Sydney">Sydney</option>
        <option value="Crypto 24/7">Crypto 24/7</option>
      </select>
    </div>
  </div>

  <div class="form-row">
    <!-- Liste déroulante d'instruments avec catégories enrichies -->
    <div class="form-group col-md-4">
      <label for="instrument">Instrument</label>
      <select class="form-control" name="instrument" id="instrument" required>
        <optgroup label="Forex">
          <option value="EUR/USD">EUR/USD</option>
          <option value="GBP/USD">GBP/USD</option>
          <option value="USD/JPY">USD/JPY</option>
          <option value="AUD/USD">AUD/USD</option>
          <option value="USD/CHF">USD/CHF</option>
          <option value="NZD/USD">NZD/USD</option>
          <option value="EUR/JPY">EUR/JPY</option>
          <option value="GBP/JPY">GBP/JPY</option>
          <option value="EUR/GBP">EUR/GBP</option>
        </optgroup>
        <optgroup label="Actions">
          <option value="AAPL">Apple (AAPL)</option>
          <option value="TSLA">Tesla (TSLA)</option>
          <option value="MSFT">Microsoft (MSFT)</option>
          <option value="AMZN">Amazon (AMZN)</option>
          <option value="GOOGL">Alphabet (GOOGL)</option>
          <option value="FB">Meta (FB)</option>
        </optgroup>
        <optgroup label="Futures">
          <option value="CAC40">CAC40</option>
          <option value="SP500">S&P 500</option>
          <option value="DAX">DAX</option>
          <option value="FTSE100">FTSE 100</option>
        </optgroup>
        <optgroup label="Commodités">
          <option value="Pétrole">Pétrole</option>
          <option value="Or">Or</option>
          <option value="Argent">Argent</option>
          <option value="Cuivre">Cuivre</option>
        </optgroup>
        <option value="Autre">Autre</option>
      </select>
      <div id="custom_instrument_div" style="display:none;">
         <label for="custom_instrument">Instrument personnalisé</label>
         <input type="text" class="form-control" name="custom_instrument">
      </div>
    </div>
    <div class="form-group col-md-4">
      <label for="position">Position</label>
      <select class="form-control" name="position" required>
        <option value="achat">Achat</option>
        <option value="vente">Vente</option>
      </select>
    </div>
    <div class="form-group col-md-4">
      <label for="prix_entree">Prix d'entrée</label>
      <input type="number" step="0.0001" class="form-control" name="prix_entree" required>
    </div>
  </div>

  <div class="form-row">
    <div class="form-group col-md-6">
      <label for="lot">Lot</label>
      <input type="number" step="0.01" class="form-control" name="lot" required>
    </div>
    <div class="form-group col-md-6">
      <label for="risk_reward">Risk/Reward <small class="text-muted">(Exemple: 1:3)</small></label>
      <input type="text" class="form-control" name="risk_reward" required>
    </div>
  </div>

  <div class="form-row">
    <div class="form-group col-md-6">
      <label for="time_frame">Time Frame utilisé</label>
      <select class="form-control" name="time_frame" id="time_frame" required>
        <option value="M1">M1</option>
        <option value="M5">M5</option>
        <option value="M15">M15</option>
        <option value="M30">M30</option>
        <option value="H1">H1</option>
        <option value="H4">H4</option>
        <option value="D1">D1</option>
        <option value="W1">W1</option>
        <option value="Custom">Custom</option>
      </select>
      <input type="text" class="form-control mt-2" name="custom_time_frame" id="custom_time_frame" placeholder="Entrez votre valeur custom si 'Custom'" style="display:none;">
    </div>
  </div>

  <div class="form-group">
    <label for="commentaires">Commentaires</label>
    <textarea class="form-control" name="commentaires"></textarea>
  </div>
  <div class="form-group">
    <label for="capture">Capture d'écran</label>
    <input type="file" class="form-control-file" name="capture">
  </div>

  <div class="form-group">
    <label for="tags">Tags (séparés par des virgules)</label>
    <input type="text" class="form-control" name="tags" placeholder="Exemple : stratégie1, matin, breakout">
  </div>

  <hr>
  <h4>Terminer le Trade (optionnel)</h4>
  <div class="form-row">
    <div class="form-group col-md-4">
      <label for="date_fin">Date de fin</label>
      <input type="date" class="form-control" name="date_fin">
    </div>
    <div class="form-group col-md-4">
      <label for="heure_fin">Heure de fin</label>
      <input type="time" class="form-control" name="heure_fin">
    </div>
    <div class="form-group col-md-4">
      <label for="prix_sortie">Prix de sortie</label>
      <input type="number" step="0.0001" class="form-control" name="prix_sortie">
    </div>
  </div>
  <button type="submit" class="btn btn-primary">Enregistrer le Trade</button>
</form>

<hr>
<h3>Trades en cours</h3>
{% if trades_encours %}
  <ul class="list-group">
    {% for trade in trades_encours %}
      <li class="list-group-item">
        <a href="{{ url_for('trade_detail', trade_id=trade.id) }}">Trade n°{{ numero_ordre_map[trade.id] }} - {{ trade.instrument }} ({{ trade.position }})</a>
        <span class="text-muted small">Ajouté le {{ trade.date_enregistrement.strftime('%Y-%m-%d %H:%M') }} | Résultat : {{ '%.2f' % trade.resultat if trade.resultat is not none else 'N/A' }} | % : {{ '%.2f' % trade.pourcentage if trade.pourcentage is not none else 'N/A' }}%</span>
        <td>
          <a href="{{ url_for('edit_trade', trade_id=trade.id) }}" class="btn btn-primary">Modifier</a>
          <form action="{{ url_for('delete_trade', trade_id=trade.id) }}" method="POST" style="display:inline;">
              <button type="submit" class="btn btn-danger" onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce trade ?');">Supprimer</button>
          </form>
        </td>
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p>Aucun trade en cours.</p>
{% endif %}

<h3>Trades terminés</h3>
{% if trades_termine %}
  <ul class="list-group">
    {% for trade in trades_termine %}
      <li class="list-group-item">
        <a href="{{ url_for('trade_detail', trade_id=trade.id) }}">Trade n°{{ numero_ordre_map[trade.id] }} - {{ trade.instrument }} ({{ trade.position }})</a>
        <span class="text-muted small">Ajouté le {{ trade.date_enregistrement.strftime('%Y-%m-%d %H:%M') }} | Résultat : {{ '%.2f' % trade.resultat if trade.resultat is not none else 'N/A' }} | % : {{ '%.2f' % trade.pourcentage if trade.pourcentage is not none else 'N/A' }}%</span>
        <td>
          <a href="{{ url_for('edit_trade', trade_id=trade.id) }}" class="btn btn-primary">Modifier</a>
          <form action="{{ url_for('delete_trade', trade_id=trade.id) }}" method="POST" style="display:inline;">
              <button type="submit" class="btn btn-danger" onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce trade ?');">Supprimer</button>
          </form>
        </td>
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p>Aucun trade terminé.</p>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
  // Afficher ou masquer le champ pour instrument personnalisé si "Autre" est sélectionné
  document.getElementById('instrument').addEventListener('change', function() {
    var customDiv = document.getElementById('custom_instrument_div');
    if (this.value === 'Autre') {
      customDiv.style.display = 'block';
    } else {
      customDiv.style.display = 'none';
    }
  });
  // Afficher ou masquer le champ pour time_frame personnalisé si "Custom" est sélectionné
  document.getElementById('time_frame').addEventListener('change', function() {
    var customDiv = document.getElementById('custom_time_frame');
    if (this.value === 'Custom') {
      customDiv.style.display = 'block';
    } else {
      customDiv.style.display = 'none';
    }
  });
</script>
{% endblock %}
